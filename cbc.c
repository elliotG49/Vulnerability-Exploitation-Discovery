#include <stdio.h>
#include <string.h>
#include <stdlib.h>

void xor_cbc_encrypt(const char *plaintext, char *key, char *iv, int block_size, int num_blocks) {
    char encrypted_text[64];
    int plaintext_length = strlen(plaintext);

    for (int i = 0; i < num_blocks; i++) {
        int block_offset = i * block_size;

        for (int counter = 0; counter < block_size; counter++) {
            int plaintext_pos = block_offset + counter;

            if (plaintext_pos < strlen(plaintext)) {
                char to_encrypt = (i == 0) ? (plaintext[plaintext_pos] ^ iv[counter]) :
                    (plaintext[plaintext_pos] ^ encrypted_text[block_offset + counter - block_size]);
                encrypted_text[block_offset + counter] = to_encrypt ^ key[counter % strlen(key)];
            }
        }
    }

    printf("Encrypted text as Hex: ");
    for (int i = 0; i < plaintext_length; i++) {
        printf("%02x", (unsigned char)encrypted_text[i]);
    }
    printf("\n");
    printf("Encrypted text as ASCII: " );
    printf(encrypted_text);
    printf("\n");
}

int main() {
        char *plaintext = (char *)malloc(64 * sizeof(char)); 
        char key[64]; 
        char *iv = (char *)malloc(64 * sizeof(char));
        signed char num_blocks;


	printf("Enter initialization vector (64 bytes): ");
        scanf("%s", iv);

        printf("Enter plaintext (64 bytes): ");
        scanf("%s", plaintext);

        printf("Enter key (up to 64 bytes): ");
        scanf("%s", key); 

        printf("Enter the number of blocks (at least 2): ");
        scanf("%hhd", &num_blocks);

        if (num_blocks < 2 ) {
            printf("Invalid number of blocks.\n");
            free(plaintext);
            free(iv);
            return 1;
        }

        int block_size = 64 / num_blocks; 
        xor_cbc_encrypt(plaintext, key, iv, block_size, num_blocks);

        free(plaintext);
        free(iv); 

    return 0;
}
